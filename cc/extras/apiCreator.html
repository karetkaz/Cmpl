<html>
<head>
<style type="text/css">
tabpanel {
	display: none;
}
tabpanel.active {
	display: block;
}
</style>
<!--script src="stdlib.api.js"></script-->
<script>
function JsArgs(paramSeparator, onHashChange) {

	// if not specified use local hash to read/save params.
	var valueSeparator = '&';
	var oldHashChange = window.onhashchange;

	if (paramSeparator !== '?') {
		paramSeparator = '#';
	}

	// read values from url
	function read(args) {
		var values = window.location.href;
		var pos = values.indexOf(paramSeparator);
		if (pos >= 0) {
			values = values.substr(pos + 1).split(valueSeparator);
		}
		else {
			values = [];
		}
		for (var i = 0; i < values.length; i += 1) {
			pos = values[i].indexOf('=');
			if (pos > 0) {
				var key = values[i].substr(0, pos);
				var value = values[i].substr(pos + 1);
				args[key] = decodeURIComponent(value);
			}
		}
		return args;
	}

	// write values to url
	function save(args, forceReload) {
		var values = '';
		for (var key in args) {
			if (!args.hasOwnProperty(key)) {
				// exclude prototype properties
				continue;
			}

			var value = args[key];
			if (value === null || value === undefined) {
				// exclude undefined and null values
				continue;
			}
			if (value.constructor !== String && value.constructor !== Number && value.constructor !== Boolean) {
				// exclude non string, number and boolean values.
				continue;
			}

			if (values !== '') {
				values += valueSeparator;
			}
			values += key + '=' + encodeURIComponent(value);
		}

		if (forceReload === true) {
			window.onHashChange = oldHashChange;
			window.location.href = paramSeparator + values;
			window.location.reload();
		}
		window.location.href = paramSeparator + values;
		return args;
	}

	// callbacks triggered on insert, update, delete
	// var onUpdate = undefined;

	var result = Object.create({
		reload: function(values) {
			// remove old entries.
			for (var key in this) {
				if (!this.hasOwnProperty(key)) {
					// do not delete properties from prototype
					continue;
				}
				delete this[key];
			}
			for (var key in values) {
				if (!values.hasOwnProperty(key)) {
					// do not delete properties from prototype
					continue;
				}
				this[key] = String(values[key]);

			}
			return save(this, true);
		},
		update: function(values) {
			var changes = Object.create(null);
			var changed = false;

			if (values === undefined) {
				values = read({});

				// remove old entries.
				for (var key in this) {
					if (!this.hasOwnProperty(key)) {
						// do not delete properties from prototype
						continue;
					}
					if (values.hasOwnProperty(key)) {
						// do not delete properties to be updated
						continue;
					}

					changes[key] = {'old': this[key]};
					delete this[key];
					changed = true;
				}
			}

			// update existing values.
			for (var key in values) {
				if (!values.hasOwnProperty(key)) {
					// do not update properties in prototype
					continue;
				}
				var oldValue = this[key];
				var newValue = String(values[key]);
				if (oldValue === newValue) {
					// do not update properties whith same values
					continue;
				}
				changes[key] = {'new': newValue, 'old': oldValue};
				this[key] = newValue;
				changed = true;
			}
			save(this);
			if (changed && onHashChange !== undefined) {
				onHashChange(this, changes);
			}
			return this;
		}
	});

	if (onHashChange !== undefined) {
		window.onhashchange = function() {
			result.update(undefined);
			if (oldHashChange != null) {
				oldHashChange(result);
			}
		};
	}

	read(result);
	if (onHashChange !== undefined) {
		onHashChange(result);
	}

	return result;
}

function writeSciteApi(node) {
	var scite_api = '';

	function writeSym(sym) {
		if (sym.declaredIn != undefined && sym.kind !== 'param') {
			scite_api += sym.declaredIn + '.';
		}
		scite_api += sym.name;
		if (sym.args !== undefined) {
			scite_api += '(';
			if (!(sym.args.length === 1 && sym.args[0].size == 0)) {
				for (var i = 0; i < sym.args.length; i += 1) {
					if (i > 0) {
						scite_api += ', ';
					}
					writeSym(sym.args[i]);
				}
			}
			scite_api += ')';
		}
		if (sym.args !== undefined || sym.kind === 'param') {
			// Scite handles only function return types
			scite_api += ": " + sym.type;
		}
	}

	for (var i = 0; i < api.length; i += 1) {
		var sym = api[i];
		/*if (sym.kind === 'opcode') {
			continue;
		}*/
		writeSym(sym);
		scite_api += '\n';
	}
	node.innerText = scite_api;
}

function writeFiltered(node, checkSymbol) {
	var scite_api = '';
	for (var i = 0; i < api.length; i += 1) {
		var sym = api[i];
		if (!checkSymbol(sym)) {
			continue;
		}
		if (sym.declaredIn != undefined) {
			scite_api += sym.declaredIn + '.';
		}
		scite_api += sym.name;
		if (sym.args !== undefined) {
			scite_api += '(';
			if (!(sym.args.length === 1 && sym.args[0].size == 0)) {
				for (var j = 0; j < sym.args.length; j += 1) {
					var arg = sym.args[j];
					if (j > 0) {
						scite_api += ', ';
					}
					scite_api += arg.type + ' ';
					scite_api += arg.name;
					scite_api += ": " + arg.type;
				}
			}
			scite_api += ')';
		}
		scite_api += ": " + sym.type + '\n';
	}
	node.innerText = scite_api;
}

function writeTypenames(node) {
	writeFiltered(node, function(sym) {
		return sym.kind === 'typename';
	});
}
function writeVariables(node) {
	writeFiltered(node, function(sym) {
		if (sym.args !== undefined) {
			return false;
		}
		return sym.kind === 'variable';
	});
}
function writeFunctions(node) {
	writeFiltered(node, function(sym) {
		if (sym.args === undefined) {
			return false;
		}
		return sym.kind === 'variable';
	});
}

function writeOpcodes(node) {
	writeFiltered(node, function(sym) {
		return sym.kind === 'opcode';
	});
}

function writeAll(node) {
	writeFiltered(node, function(sym) {
		return true;
	});
}

function setActiveTab(node, contentWriter) {
	var elements = document.getElementsByTagName('tabpanel');
	for (var i = 0; i < elements.length; i++) {
		var element = elements[i];
		if (element === node.parentNode) {
			element.classList.add('active');
		}
		else {
			element.classList.remove('active');
		}
//~ 		element.setAttribute('class',  ? '' : 'active');
	}
	if (contentWriter !== undefined) {
		contentWriter(node, arguments[2]);
	}
}

var filters = JsArgs('#', function(jsargs, changes) {
	console.log('hash.changed: ' + JSON.stringify({args: jsargs, changes: changes}));
	if (jsargs.file === undefined) {
		jsargs.reload({file: 'stdlib.api.js'});
		return;
	}
	// something changed, reload page
	if (changes !== undefined) {
		window.location.reload();
	}
});

</script>
<script type="application/javascript">// read js file based on arguments
document.write('<script type="application/javascript" src="' + filters.file + '"></' + 'script>');
</script>
</head>
<body>
<tabbox>
  <tabs>
    <tab onClick="setActiveTab(scite_api, writeSciteApi);">Scite Api</tab>
    <tab onClick="setActiveTab(typenames, writeTypenames);">Typenamess</tab>
    <tab onClick="setActiveTab(typenames, writeVariables);">Variables</tab>
    <tab onClick="setActiveTab(typenames, writeFunctions);">Functions</tab>
    <tab onClick="setActiveTab(typenames, writeOpcodes);">Opcodes</tab>
    <tab onClick="setActiveTab(typenames, writeAll);">All</tab>
    <tab onClick="setActiveTab(search);">Search</tab>
  </tabs>
  <tabpanels>
    <tabpanel clas=""><pre id="scite_api" fetchdata></pre></tabpanel>
    <tabpanel clas=""><pre id="typenames"></pre></tabpanel>
    <tabpanel clas=""><pre id="search"></pre></tabpanel>
  </tabpanels>
</tabbox>
</body>
</html>
