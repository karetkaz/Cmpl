// Mandelbrot demo.
enum Window {
	draw = RenderMode.swap_buff;
	resx = 512;
	resy = 512;
}

double QMin = -1.5;
double QMax = +1.5;
double PMin = -2.25;
double PMax = +0.75;

//~ //Mandel(-0.441324 ± 8.081852e-04, -1.295320 ± 8.081852e-04): time: 0.680000
//~ define zoom = 8.081852e-04;
//~ double QMin = -0.441324-zoom;
//~ double QMax = -0.441324+zoom;
//~ double PMin = -1.295320-zoom;
//~ double PMax = -1.295320+zoom;

gxClut mandelLut;
blendLut(32, &mandelLut, 0x000020, 0xffffff, 0x0000ff);
//~ blendLut(32, &mandelLut, 0xFFFFFF, 0x000000, 0xadadff, 0x000000);
//~ const int colors[] = {0xFFFFFF, 0xa9cffa, 0x8ab7ee, 0x7ba5e9, 0x7295db, 0x6987cb, 0x5e7ec5, 0x4f6fb3, 0x3a5393, 0x2c3e73, 0x1d3165, 0x070e50};
//~ blendLut(64, &mandelLut, colors);

int reDraw = 1;
gxRect roi = gxRect(Window.resx / 2 - Window.resx / 4, Window.resy / 2 - Window.resy / 4, Window.resx / 2, Window.resy / 2);

gxSurf mand = gxSurf(Window.resx, Window.resy);

void mouseCB(int btn, int x, int y) {
	define scale = 1.4142;
	static int omb = 0;

	if (reDraw == false) {
		int zoom = 0;

		if (btn == 1 || (btn == 0 && omb == 1)) {
			zoom = +1;
		}
		if (btn == 0 && omb == 2) {
			zoom = -1;
		}

		if (zoom == +1) {

			reDraw = 2;
			double dx = (PMax - PMin);
			double dy = (QMax - QMin);

			double X = (2. * x / Window.resx - 1) * dx / 2;
			double Y = (2. * y / Window.resy - 1) * dy / 2;

			dx = dx / (2 * scale);
			dy = dy / (2 * scale);

			if (btn == 0) {
				PMin += X + dx;
				PMax += X - dx;
				QMin += Y + dy;
				QMax += Y - dy;
				reDraw = 1;
			}

			if (true) {
				int dx = Window.resx / 8;
				int dy = Window.resy / 8;
				roi = gxRect(x - dx, y - dy, dx * 2, dy * 2);
			}
		}
		else if (zoom == -1) {
			double dx = (PMax - PMin);
			double dy = (QMax - QMin);
			dx = dx / (2 * scale);
			dy = dy / (2 * scale);

			PMin -= dx;
			PMax += dx;
			QMin -= dy;
			QMax += dy;
			reDraw = true;
		}
		if (btn == 4 || btn == 16) {
			reDraw = 1;
			QMin = -1.5;
			QMax = +1.5;
			PMin = -2.25;
			PMax = +0.75;
		}
	}
	omb = btn;
}
void drawCB() {
	if (reDraw == 2) {
		copySurf(offScreen, 0, 0, mand, null);
		drawRect(offScreen, roi, 0xff0000);
		//~ zoomSurf(offScreen, null, mand, &roi, 1);
		reDraw = 0;
	}
	if (reDraw == 1) {
		int32 start = clock();
		//~ Mandel(offScreen, &mandelLut, QMin, QMax, PMin, PMax);
		Mandel(mand, &mandelLut, QMin, QMax, PMin, PMax);
		copySurf(offScreen, 0, 0, mand, null);
		double QSize = QMax - QMin;
		double PSize = PMax - PMin;

		print("Mandel(%F", QMin + QSize / 2);
		print(" ± %E", QSize / 2);
		print(", %F", PMin + PSize / 2);
		print(" ± %E", PSize / 2);
		print("): time: %F\n", clocks2Sec(clock() - start));

		reDraw = 0;
	}
}

Gui.setMouseHandler(mouseCB);
Gui.setDrawCallback(drawCB);
//~ bmpWrite(Mandel(gxSurf(2000), &mandelLut, QMin, QMax, PMin, PMax), "mandel.bmp");
