<html>
<head>
	<title>Cmpl live demo</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">

	<!-- Other libs -->
	<link rel="stylesheet" href="main.css">
	<script type="text/javascript" src="lib/FileSaver.js"></script>
	<script type="text/javascript" src="lib/JsArgs.js"></script>
	<script type="text/javascript" src="lib/JsTerm.js"></script>

	<!-- Bootstrap -->
	<link rel="stylesheet" href="lib/bootstrap/css/bootstrap.css">
	<script src="lib/jquery/jquery.js">/*TODO: use .min.js*/</script>
	<script src="lib/popper/popper.js">/*TODO: use .min.js*/</script>
	<script src="lib/bootstrap/js/bootstrap.js">/*TODO: use .min.js*/</script>

	<!-- Code mirror -->
	<link rel="stylesheet" href="lib/codemirror/codemirror.css">
	<link rel="stylesheet" href="lib/codemirror/theme/idea.css" />
	<link rel="stylesheet" href="lib/codemirror/theme/darcula.css" />
	<link rel="stylesheet" href="lib/codemirror/fold/foldgutter.css" />
	<script src="lib/codemirror/codemirror.js"></script>
	<script src="lib/codemirror/fold/foldcode.js"></script>
	<script src="lib/codemirror/fold/brace-fold.js"></script>
	<script src="lib/codemirror/fold/comment-fold.js"></script>
	<script src="lib/codemirror/fold/foldgutter.js"></script>
	<script src="lib/codemirror/addon/active-line.js"></script>
	<script src="lib/codemirror/addon/matchbrackets.js"></script>
	<script src="lib/codemirror/addon/trailingspace.js"></script>
	<script src="lib/codemirror/addon/scroll/annotatescrollbar.js"></script>
	<script src="lib/codemirror/addon/search/matchesonscrollbar.js"></script>
	<script src="lib/codemirror/addon/search/searchcursor.js"></script>
	<script src="lib/codemirror/addon/search/match-highlighter.js"></script>

	<script src="lib/codemirror/lang/cmpl.js"></script>

</head>
<body>
<div class="header" style="height: 2.6em">
	<nav>
		<div class="nav nav-tabs" id="nav-tab" role="tablist">
			<li class="nav-item dropdown active" id="nav-input-tab" data-toggle="tab" href="#nav-input" role="tab" aria-controls="nav-input" aria-selected="true">
				<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Input</a>
				<div id="fileList" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
					<a class="dropdown-item" href="#" onClick="downloadInput();">Dowload file</a>
					<a class="dropdown-item" href="#" onClick="shareInput();">Create link</a>
					<a class="dropdown-item" href="#" onClick="saveInput();">Save file</a>
					<a class="dropdown-item" href="#" onClick="params.update({file: null, content: null});">Close</a>
					<div class="dropdown-divider"></div>
				</div>
			</li>
			<li class="nav-item dropdown" data-toggle="tab" href="#nav-output" role="tab" aria-controls="nav-output" aria-selected="false">
				<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">View</a>
				<div class="dropdown-menu">
					<a class="dropdown-item" href="#" onclick="showConsole(false);">Input</a>
					<a class="dropdown-item" href="#" onclick="showConsole(true);">Output</a>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" href="#" onclick="showConsole(null, '');">Split auto</a>
					<a class="dropdown-item" href="#" onclick="showConsole(null, 'vertical');">Split vertical</a>
					<a class="dropdown-item" href="#" onclick="showConsole(null, 'horizontal');">Split horizontal</a>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" href="#" onclick="params.update({theme: 'idea'});">Light theme</a>
					<a class="dropdown-item" href="#" onclick="params.update({theme: 'darcula'});">Dark theme</a>
				</div>
			</li>
			<li class="nav-item btn-group dropright" href="#" role="tab" aria-controls="nav-output" aria-selected="false">
				<button id="btnExecute" type="button" class="btn btn-sm btn-default" onclick="execute(cmdExecute.value);">Execute</button>
				<button type="button" class="btn btn-sm btn-default dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
				<div class="dropdown-menu">
					<a class="dropdown-item" href="#" onclick="params.update({exec: null}); btnExecute.innerText=this.innerText; cmdExecute.value='-run/g'; return false;">Run</a>
					<a class="dropdown-item" href="#" onclick="params.update({exec: null}); btnExecute.innerText=this.innerText; cmdExecute.value='-debug/g'; return false;">Debug</a>
					<a class="dropdown-item" href="#" onclick="params.update({exec: null}); btnExecute.innerText=this.innerText; cmdExecute.value='-profile/g'; return false;">Profile</a>
					<a class="dropdown-item" href="#" onclick="params.update({exec: null}); btnExecute.innerText='Compile'; cmdExecute.value=''; return false;">Compile only</a>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" onclick="params.update({exec: cmdExecute.value});"><input class="btn-block" id="cmdExecute" onchange="params.update({exec: value});" type="text" value=""></a>
					<span class="dropdown-item">
						<button type="button" class="btn btn-light" onclick="params.update({exec: null}); btnExecute.innerText=this.innerText; cmdExecute.value='-asm/a/n/s/m';">Asm</button>
						<button type="button" class="btn btn-light" onclick="params.update({exec: null}); btnExecute.innerText=this.innerText; cmdExecute.value='-api/a';">Tags</button>
						<button type="button" class="btn btn-light" onclick="params.update({exec: null}); btnExecute.innerText=this.innerText; cmdExecute.value='-api/u';">Usages</button>
					</span>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" href="#" onclick="terminal.clear(); return false;">Clear output</a>
				</div>
			</li>
		</div>
	</nav>
</div>
<div class="split-pane" style="top:2.6em;">
	<div class="text-content">
		<textarea id="input"></textarea>
	</div>
	<div class="text-content">
		<pre id="output"></pre>
	</div>
</div>
</body>
<script type="text/javascript">
	/* communication with worker/args
	send => {
		files - download these files to the workspace directory
		file - open or save the content of the file
		line - jump to / position in file
		data(content) - save the content
		exec - arguments for the compiler
	}

	receive => {
		files - list of files in the workspace
		data(content) - content of the requested file
		line - jump to / position in file
		print - print the message to the output
	}

	args => {
		files - to add: download files to a new workspace
		file - the file to be opened
		data(content) - overwrite the content of the file
		exec
		theme
		dump
		log
		mem
		X
	}*/

	let worker = new Worker('worker.js');
	let editor = CodeMirror.fromTextArea(input, {
		mode: "text/x-cmpl",
		lineNumbers: true,
		tabSize: 4,
		indentUnit: 4,
		indentWithTabs: true,

		styleActiveLine: true,
		matchBrackets: true,
		showTrailingSpace: true,

		foldGutter: true,
		gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
		highlightSelectionMatches: {showToken: /\w/, annotateScrollbar: true}
	});
	let terminal = Terminal(output, function(escaped, text) {
		// detect uris and file names with line numbers
		return escaped.replace(/(?=[\w\/])(\w+:\/\/[^\/]+)?([^<>=:;,?#"*|\n\r]+)(?::(\d+))?(?!\/)(?::(\d+))?\b/g, function (match, host, file, line, column) {
			line = +(line || 0);
			column = +(column || 0);
			if (host != null) {
				return '<a href="#" onClick="return false;">' + match + '</a>';
			}
			if (line > 0) {
				return '<a href="#" onClick="return goTo(\'' + file + '\', ' + line + ', ' + column + ');">' + match + '</a>';
			}
			return match;
		});
	});
	let params = JsArgs('#', function (params, changes) {
		// change execution method
		if (!changes || changes.exec != null) {
			if (params.exec == null) {
				cmdExecute.value = '-run/g';
				btnExecute.innerText = 'Run';
			} else {
				cmdExecute.value = params.exec;
				btnExecute.innerText = 'Execute';
			}
		}

		// change theme
		if (!changes || changes.theme != null) {
			editor.setOption("theme", params.theme || "default");
		}

		if (changes === undefined) {
			// wait for onRuntimeInitialized
			return;
		}

		// reload page if the file list was modified
		if (changes.files) {
			params.update(true);
		}

		// file or content field changed (open or close)
		if (changes.content != null || changes.file != null) {
			let content = params.content;
			try {
				if (content != null) {
					content = atob(content);
				}
			} catch (e) {
				console.warn(e);
			}
			editor.setValue(content || '');
			if (params.file != null) {
				document.title = params.file + " - " + docTitle;
				worker.postMessage({
					file: params.file,
					line: params.line,
					content: content
				});
			} else {
				document.title = docTitle;
			}
		}
		if (changes.line && params.line != null) {
			editor.setCursor(params.line - 1);
		}

	});
	let docTitle = document.title;

	editor.setSize('100%', '100%');
	worker.onmessage = function(event) {
		let data = event.data;
		if (data.print !== undefined) {
			terminal.print(data.print);
		}
		if (data.content !== undefined) {
			editor.setValue(data.content);
		}
		if (data.file !== undefined) {
			params.update({file: data.file});
		}
		if (data.line !== undefined) {
			params.update({line: data.line});
		}
		if (data.files !== undefined) {
			for (let file of data.files) {
				fileList.innerHTML += '<a class="dropdown-item" href="#" onClick="params.update({file: this.innerText, content: null});">' + file + '</a>';
			}
			params.update('file', 'content');
		}
	};
	if (params.files != null) {
		worker.postMessage({files: params.files.split(';')});
	}

	function goTo(file, line, column) {
		editor.setCursor(line - 1, column);
		if (file != params.file) {
			params.update({
				file: file,
				line: line,
				content: null
			});
		}
		return false;
	}

	function showConsole(inout, orientation) {
		$('.split-pane')
		.removeClass('primary')
		.removeClass('secondary')
		.removeClass('vertical')
		.removeClass('horizontal');

		if (inout === false) {
			$('.split-pane').addClass('primary');
		}
		else if (inout === true) {
			$('.split-pane').addClass('secondary');
		}
		if (orientation === 'vertical') {
			$('.split-pane').addClass('vertical');
		}
		else if (orientation === 'horizontal') {
			$('.split-pane').addClass('horizontal');
		}
	}

	function downloadInput() {
		let type = "application/octet-stream";
		saveAs(new Blob([editor.getValue()], {type: type}), params.file);
	}

	function shareInput() {
		params.update({
			content: btoa(editor.getValue())
		});
	}

	function saveInput() {
		let file = params.file;
		if (file == null) {
			file = prompt('Save file as:', 'untitled.ci');
		}
		if (file == null) {
			return;
		}
		worker.postMessage({
			file: file,
			content: editor.getValue()
		});
		params.update({
			file: file,
			content: null
		});
	}

	function execute(mode) {
		let args = [
			'-std/stdlib.ci',                               // standard library is in root
			'-mem' + (params.mem || '2M'),                  // allocate 2Mb of memory by default,
			'-X' + (params.X || '-stdin+times'),            // do not use standard input, print times
		];

		if (params.dump != null) {
			if (params.dump.endsWith('.json')) {
				args.push('-dump.json');
			} else {
				args.push('-dump');
			}
			args.push(params.dump);
		}

		if (params.log != null) {
			args.push('-log');
			args.push(params.log);
		}

		for (let arg of mode.split(' ')) {
			if (arg === '') {
				continue;
			}
			args.push(arg);
		}

		terminal.clear();

		// compile the code
		let file = params.file || 'new.ci';
		args.push(file);
		worker.postMessage({
			content: editor.getValue(),
			file: file,
			exec: args
		});
	}
</script>
</html>
