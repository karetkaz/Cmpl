<html>
<head>
	<title>Cmpl live demo</title>

	<!--<meta name="viewport" content="width=device-width">-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script src="lib/jquery/jquery.js">/*TODO: use .min.js*/</script>
	<script src="lib/popper/popper.js">/*TODO: use .min.js*/</script>
	<link rel="stylesheet" href="lib/bootstrap/css/bootstrap.css">
	<!--link rel="stylesheet" href="lib/bootstrap/css/bootstrap-theme.min.css"-->
	<script src="lib/bootstrap/js/bootstrap.js">/*TODO: use .min.js*/</script>

	<!--Code mirror code-->
	<link rel="stylesheet" href="lib/codemirror/codemirror.css">
	<script src="lib/codemirror/codemirror.js"></script>
	<script src="cmpl.lang.js"></script>

	<!--libraries-->
	<link rel="stylesheet" href="main.css">
	<script type="text/javascript" src="lib/FileSaver.js"></script>
	<script type="text/javascript" src="cmpl.js"></script>

</head>
<body>
<div class="header" style="height: 2.5em">
	<nav>
		<div class="nav nav-tabs" id="nav-tab" role="tablist">
			<li class="nav-item dropdown active" id="nav-input-tab" data-toggle="tab" href="#nav-input" role="tab" aria-controls="nav-input" aria-selected="true">
				<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Input</a>
				<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
					<a class="dropdown-item" href="#" onClick="saveInput();">Save</a>
					<a class="dropdown-item" href="#" onClick="openInput(null);">Close</a>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" href="#" onClick="openInput('function.ci');">function</a>
					<a class="dropdown-item" href="#" onClick="openInput('execute.ci');">tryExec</a>
				</div>
			</li>
			<!--a class="nav-item nav-link active" id="nav-output-tab" data-toggle="tab" href="#nav-output" role="tab" aria-controls="nav-output" aria-selected="true">Output</a-->
			<li class="nav-item dropdown" data-toggle="tab" href="#nav-output" role="tab" aria-controls="nav-output" aria-selected="false">
				<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">View</a>
				<div class="dropdown-menu">
					<a class="dropdown-item" onclick="showConsole(false)">Input</a>
					<a class="dropdown-item" onclick="showConsole(true)">Output</a>
					<a class="dropdown-item" onclick="showConsole(null, '')">Split auto</a>
					<a class="dropdown-item" onclick="showConsole(null, 'vertical')">Split vertical</a>
					<a class="dropdown-item" onclick="showConsole(null, 'horizontal')">Split horizontal</a>
				</div>
			</li>
			<div class="nav-item btn-group dropright">
				<button id="btnExecute" type="button" class="btn btn-sm btn-default" onclick="execute(cmdExecute.value);">
					Run
				</button>
				<button type="button" class="btn btn-sm btn-default dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				</button>
				<div class="dropdown-menu">
					<a class="dropdown-item" onclick="btnExecute.innerText=this.innerText; cmdExecute.value='-run/g';">Run</a>
					<a class="dropdown-item" onclick="btnExecute.innerText=this.innerText; cmdExecute.value='-debug/g';">Debug</a>
					<a class="dropdown-item" onclick="btnExecute.innerText=this.innerText; cmdExecute.value='-profile/g';">Profile</a>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" onclick="btnExecute.innerText=this.innerText; cmdExecute.value='';">Compile</a>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" onclick="btnExecute.innerText='Custom';"><input id="cmdExecute" type="text" value="-run/g"></a>
					<span class="dropdown-item">
						<button type="button" class="btn btn-light" onclick="btnExecute.innerText='Custom'; cmdExecute.value='-api/a';">Api</button>
						<button type="button" class="btn btn-light" onclick="btnExecute.innerText='Custom'; cmdExecute.value='-asm/a/n/s/m';">Asm</button>
						<button type="button" class="btn btn-light" onclick="btnExecute.innerText='Custom'; cmdExecute.value='-ast';">Ast</button>
					</span>
				</div>
			</div>
			<!--a class="nav-item nav-link disabled" id="nav-canvas-tab" data-toggle="tab" href="#nav-canvas" role="tab" aria-controls="nav-canvas" aria-selected="false">Canvas</a>
			<li class="nav-item dropdown disabled" id="nav-files-tab" data-toggle="tab" href="#nav-files" role="tab" aria-controls="nav-files" aria-selected="false">
				<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Download</a>
				<div class="dropdown-menu">
					<a class="dropdown-item" href="#">Input</a>
					<a class="dropdown-item" href="#">Output</a>
					<a class="dropdown-item" href="#">Dump</a>
					<a class="dropdown-item" href="#">Log</a>
				</div>
			</li-->
		</div>
	</nav>
</div>
<div class="split-pane" style="top:2.5em">
	<div class="split-input">
		<div class="text-content">
		<textarea id="input">
void empty() {}

// function with implementation
int funAdd(int x, int y) {
	return x + y;
}

// function invocation
int funAddResult = funAdd(2, 7);

// initialized function reference
int funAddRef(int x, int y) = funAdd;

// function reference invocation
int funAddRefResult = funAddRef(2, 8);

// forward function reference (must be implemented somewhere)
int funMul(int x, int y);

// forward function invocation
int funMulResult = funMul(2, 6);

// initialized forward function reference (copy address)
int funMulRef(int x, int y) = funMul;

// forward function reference invocation
int funMulRefResult = funMulRef(2, 7);

// forward function implementation
int funMul(int x, int y) {
	return x * y;
}

// recursive function implementation
uint32 fib(uint32 n) {
	if (n <= 1) {
		return n;
	}
	return fib(n-1) + fib(n-2);
}

// recursive function invocation
uint32 fibonacci_23 = fib(23);
</textarea>
		</div>
	</div>
	<div class="split-output">
		<div class="text-content">
			<textarea id="output" rows="30" readonly spellcheck="false"></textarea>
		</div>
	</div>
</div>
</body>
<script type="text/javascript">
	var editor = CodeMirror.fromTextArea(document.getElementById("input"), {
		mode: "text/x-cmpl",
		lineNumbers: true,
		matchBrackets: true,
		tabSize: 4,
		indentUnit: 4,
		indentWithTabs: true
	});
	var terminal = terminalFromTextArea(document.getElementById("output"));
	editor.setSize('100%', '100%');
	Module.print = terminal.print;

	$('#nav-output-tab').click(function (ev) {
		var shown = $('.split-pane').hasClass('secondary');
		showConsole(shown ? null : true);
	});

	function terminalFromTextArea(output) {
		if (output == null) {
			return {
				print: console.log,
				clear: function () {
				}
			}
		}

		return {
			print: function (text) {
				if (arguments.length > 1) {
					text = Array.prototype.slice.call(arguments).join(' ');
				}
				// show and focus the message as soon as possible
				setTimeout(function () {
					output.value += text + "\n";
					output.scrollTop = output.scrollHeight;
				});
			},
			clear: function () {
				setTimeout(function () {
					output.value = '';
				});
			}
		};
	}

	function saveFSFile(fileName) {
		if (fileName == null) {
			fileName = prompt('Download file:', 'stdlib.ci');
			if (fileName == null) {
				return;
			}
		}
		var type = "application/octet-stream";
		var data = FS.readFile(fileName);
		saveAs(new Blob([data.buffer], {type: type}), fileName);
	}

	function showConsole(inout, orientation) {
		$('.split-pane')
			.removeClass('primary')
			.removeClass('secondary')
			.removeClass('vertical')
			.removeClass('horizontal');

		if (inout === false) {
			$('.split-pane').addClass('primary');
		}
		else if (inout === true) {
			$('.split-pane').addClass('secondary');
		}
		if (orientation === 'vertical') {
			$('.split-pane').addClass('vertical');
		}
		else if (orientation === 'horizontal') {
			$('.split-pane').addClass('horizontal');
		}
	}

	function openInput(fileName) {
		if (fileName == null) {
			editor.setValue('');
			return;
		}
		var data = FS.readFile(fileName);
		var dec = new TextDecoder("utf-8");

		editor.setValue(dec.decode(data.buffer));
	}

	function saveInput() {
		var inputFile = 'input.ci';
		FS.writeFile(inputFile, editor.getValue());
		saveFSFile(inputFile);
	}

	function execute(mode) {
		console.log(mode);
		var args = [
			'-X-stdin',         // do not use standard input
			'-mem3M'            // allocate 3Mb memory in heap
		];

		if (mode != null && mode !== '') {
			args.push(mode);
		}

		terminal.clear();

		// save the content of the editor to memory file
		var inputFile = 'input';
		FS.writeFile(inputFile, editor.getValue());

		// compile the code
		args.push(inputFile);
		Module['callMain'](args);
	}
</script>
</html>
