<html>
<head>
	<title>Cmpl live demo</title>

	<!--<meta name="viewport" content="width=device-width">-->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Bootstrap -->
	<link rel="stylesheet" href="lib/bootstrap/css/bootstrap.css">
	<script src="lib/jquery/jquery.js">/*TODO: use .min.js*/</script>
	<script src="lib/popper/popper.js">/*TODO: use .min.js*/</script>
	<script src="lib/bootstrap/js/bootstrap.js">/*TODO: use .min.js*/</script>

	<!-- Code mirror -->
	<link rel="stylesheet" href="lib/codemirror/codemirror.css">
	<script src="lib/codemirror/codemirror.js"></script>
	<script src="cmpl.lang.js"></script>

	<!-- Other libs -->
	<link rel="stylesheet" href="main.css">
	<script type="text/javascript" src="lib/FileSaver.js"></script>
	<script type="text/javascript" src="lib/JsArgs.js"></script>
	<script type="text/javascript" src="cmpl.js"></script>

</head>
<body>
<div class="header" style="height: 2.5em">
	<nav>
		<div class="nav nav-tabs" id="nav-tab" role="tablist">
			<li class="nav-item dropdown active" id="nav-input-tab" data-toggle="tab" href="#nav-input" role="tab" aria-controls="nav-input" aria-selected="true">
				<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Input</a>
				<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
					<a class="dropdown-item" href="#" onClick="saveInput();">Save</a>
					<a class="dropdown-item" href="#" onClick="params.update({input: null});">Close</a>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" href="#" onClick="params.update({input: 'function.ci'});">function</a>
					<a class="dropdown-item" href="#" onClick="params.update({input: 'execute.ci', exec: '-debug/g/L'});">tryExec</a>
				</div>
			</li>
			<!--a class="nav-item nav-link active" id="nav-output-tab" data-toggle="tab" href="#nav-output" role="tab" aria-controls="nav-output" aria-selected="true">Output</a-->
			<li class="nav-item dropdown" data-toggle="tab" href="#nav-output" role="tab" aria-controls="nav-output" aria-selected="false">
				<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">View</a>
				<div class="dropdown-menu">
					<a class="dropdown-item" onclick="showConsole(false)">Input</a>
					<a class="dropdown-item" onclick="showConsole(true)">Output</a>
					<a class="dropdown-item" onclick="showConsole(null, '')">Split auto</a>
					<a class="dropdown-item" onclick="showConsole(null, 'vertical')">Split vertical</a>
					<a class="dropdown-item" onclick="showConsole(null, 'horizontal')">Split horizontal</a>
				</div>
			</li>
			<div class="nav-item btn-group dropright">
				<button id="btnExecute" type="button" class="btn btn-sm btn-default" onclick="execute(cmdExecute.value);">Run</button>
				<button type="button" class="btn btn-sm btn-default dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
				<div class="dropdown-menu">
					<a class="dropdown-item" onclick="params.update({exec: null}); btnExecute.innerText=this.innerText; cmdExecute.value='-run/g';">Run</a>
					<a class="dropdown-item" onclick="params.update({exec: null}); btnExecute.innerText=this.innerText; cmdExecute.value='-debug/g';">Debug</a>
					<a class="dropdown-item" onclick="params.update({exec: null}); btnExecute.innerText=this.innerText; cmdExecute.value='-profile/g';">Profile</a>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" onclick="params.update({exec: null}); btnExecute.innerText=this.innerText; cmdExecute.value='';">Compile</a>
					<div class="dropdown-divider"></div>
					<a class="dropdown-item" onclick="params.update({exec: null}); btnExecute.innerText='Custom';"><input id="cmdExecute" type="text" value="-run/g"></a>
					<span class="dropdown-item">
						<button type="button" class="btn btn-light" onclick="params.update({exec: null}); btnExecute.innerText='Tags'; cmdExecute.value='-api/a';">Tags</button>
						<button type="button" class="btn btn-light" onclick="params.update({exec: null}); btnExecute.innerText='Usages'; cmdExecute.value='-api/u';">Usages</button>
						<button type="button" class="btn btn-light" onclick="params.update({exec: null}); btnExecute.innerText='Assembly'; cmdExecute.value='-asm/a/n/s/m';">Asm</button>
					</span>
				</div>
			</div>
			<!--a class="nav-item nav-link disabled" id="nav-canvas-tab" data-toggle="tab" href="#nav-canvas" role="tab" aria-controls="nav-canvas" aria-selected="false">Canvas</a>
			<li class="nav-item dropdown disabled" id="nav-files-tab" data-toggle="tab" href="#nav-files" role="tab" aria-controls="nav-files" aria-selected="false">
				<a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Download</a>
				<div class="dropdown-menu">
					<a class="dropdown-item" href="#">Input</a>
					<a class="dropdown-item" href="#">Output</a>
					<a class="dropdown-item" href="#">Dump</a>
					<a class="dropdown-item" href="#">Log</a>
				</div>
			</li-->
		</div>
	</nav>
</div>
<div class="split-pane" style="top:2.5em">
	<div class="split-input">
		<div class="text-content">
		<textarea id="input"></textarea>
		</div>
	</div>
	<div class="split-output">
		<div class="text-content">
			<textarea id="output" rows="30" readonly spellcheck="false"></textarea>
		</div>
	</div>
</div>
</body>
<script type="text/javascript">
	var editor = CodeMirror.fromTextArea(document.getElementById("input"), {
		mode: "text/x-cmpl",
		lineNumbers: true,
		matchBrackets: true,
		tabSize: 4,
		indentUnit: 4,
		indentWithTabs: true
	});
	var terminal = terminalFromTextArea(document.getElementById("output"));
	var params = JsArgs(function (params, changes) {
		console.log('hash.changed: ' + JSON.stringify({params: params, changes: changes}));
		if (changes === undefined) {
			// wait for onRuntimeInitialized
			return;
		}
		if (changes.exec != null && params.exec != null) {
			cmdExecute.value = params.exec;
			btnExecute.innerText = 'Custom';
		}
		// input field changed (open or close)
		if (changes.input != null) {
			openInput(params.input);
		}
	});

	editor.setSize('100%', '100%');
	Module.print = terminal.print;
	Module.onRuntimeInitialized = function () {
		params.update();
	};

	function terminalFromTextArea(output) {
		if (output == null) {
			return {
				print: console.log,
				clear: function () {
				}
			}
		}

		return {
			print: function (text) {
				if (arguments.length > 1) {
					text = Array.prototype.slice.call(arguments).join(' ');
				}
				// show and focus the message as soon as possible
				setTimeout(function () {
					output.value += text + "\n";
					output.scrollTop = output.scrollHeight;
				});
			},
			clear: function () {
				setTimeout(function () {
					output.value = '';
				});
			}
		};
	}

	function saveFSFile(fileName) {
		if (fileName == null) {
			fileName = prompt('Download file:', 'stdlib.ci');
			if (fileName == null) {
				return;
			}
		}
		var type = "application/octet-stream";
		var data = FS.readFile(fileName);
		saveAs(new Blob([data.buffer], {type: type}), fileName);
	}

	function showConsole(inout, orientation) {
		$('.split-pane')
			.removeClass('primary')
			.removeClass('secondary')
			.removeClass('vertical')
			.removeClass('horizontal');

		if (inout === false) {
			$('.split-pane').addClass('primary');
		}
		else if (inout === true) {
			$('.split-pane').addClass('secondary');
		}
		if (orientation === 'vertical') {
			$('.split-pane').addClass('vertical');
		}
		else if (orientation === 'horizontal') {
			$('.split-pane').addClass('horizontal');
		}
	}

	function openInput(fileName) {
		terminal.clear();
		if (fileName == null) {
			editor.setValue('');
			return;
		}
		try {
			var data = FS.readFile(fileName);
			var dec = new TextDecoder('utf-8');
			editor.setValue(dec.decode(data.buffer));
			terminal.print('opening file succeeded: `' + fileName + '`');
		} catch (err) {
			terminal.print('opening file failed: `' + fileName + '`: ' + err);
		}
	}

	function saveInput() {
		var inputFile = 'input.ci';
		FS.writeFile(inputFile, editor.getValue());
		saveFSFile(inputFile);
	}

	function execute(mode) {
		var args = [
			'-X' + (params.X || '-stdin'),      // do not use standard input
			'-mem' + (params.mem || '2M')       // allocate 2Mb of memory by default
		];

		if (params.dump != null) {
			if (params.dump.endsWith('.json')) {
				args.push('-dump.json');
			} else {
				args.push('-dump');
			}
			args.push(params.dump);
		}

		if (params.log != null) {
			args.push('-log');
			args.push(params.log);
		}

		if (mode != null && mode !== '') {
			args.push(mode);
		}

		terminal.clear();

		// save the content of the editor to memory file
		var inputFile = 'input';
		FS.writeFile(inputFile, editor.getValue());

		// compile the code
		args.push(inputFile);
		Module['callMain'](args);
	}
</script>
</html>
