<html>
<head>
	<meta charset="UTF-8">
	<title>Cmpl live demo</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">

	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="theme.css">

	<script type="text/javascript" src="lib/JsArgs.js"></script>
	<script type="text/javascript" src="lib/JsTerm.js"></script>

	<!-- Code mirror -->
	<link rel="stylesheet" href="lib/codemirror/lib/codemirror.css">
	<link rel="stylesheet" href="lib/codemirror/addon/fold/foldgutter.css" />
	<script src="lib/codemirror/lib/codemirror.js"></script>
	<script src="lib/codemirror/addon/fold/foldcode.js"></script>
	<script src="lib/codemirror/addon/fold/brace-fold.js"></script>
	<script src="lib/codemirror/addon/fold/comment-fold.js"></script>
	<script src="lib/codemirror/addon/fold/foldgutter.js"></script>
	<script src="lib/codemirror/addon/selection/active-line.js"></script>
	<script src="lib/codemirror/addon/edit/matchbrackets.js"></script>
	<script src="lib/codemirror/addon/edit/trailingspace.js"></script>
	<script src="lib/codemirror/addon/scroll/annotatescrollbar.js"></script>
	<script src="lib/codemirror/addon/search/matchesonscrollbar.js"></script>
	<script src="lib/codemirror/addon/search/searchcursor.js"></script>
	<script src="lib/codemirror/addon/search/match-highlighter.js"></script>
	<script src="lib/codemirror/addon/comment/comment.js"></script>
	<script src="lib/codemirror/cmpl.js"></script>
	<script src="lib/codemirror/keys.js"></script>
</head>
<body class="dark tool left-bar left-pin editor output">
<div id="main-toolbar" class="toolbar">
	<span class="left icon" title="Toggle show menu" onclick="setStyle(body, '!left-bar', 'editor');">☰</span>
	<span class="left icon" title="Save script (Ctrl + s)" onclick="saveInput();">💾</span>
	<span class="left icon" title="Execute script (Ctrl + Enter)" onclick="onExecClick();">►</span>

	<span class="right icon" title="Toggle show menu" onclick="setStyle(body, '!right-bar', 'editor');">⋮</span>
	<span class="canvas right icon" title="Stop execution" onclick="showCanvas(false);">❌</span>
	<span class="right icon" title="Toggle show output" onclick="setStyle(body, '!output', 'editor');">⬓</span>
	<span class="right icon" title="Toggle dark theme" onclick="setStyle(body, '!dark');">◑</span>

	<span class="output-only right icon bold" title="Scroll to end" onclick="terminal.scroll(true);">⏬</span>
	<span class="output-only right icon bold" title="Scroll to top" onclick="terminal.scroll(false);">⏫</span>

	<!-- filename -->
	<span class="filename" title="Execute action (Shift + Enter)
	'#args' Execute script
	'?text' Search (Ctrl + f)
	':line' Go to line (Ctrl + g)
	'-' Fold all lines (Ctrl + Shift + -)
	'+' Unfold all lines (Ctrl + Shift + +)">
	<input id="edtFileName" placeholder="#execute; ?search; :goto; -fold; +unfold"></input></span>
</div>
<div id="left-sidebar" class="sidebar">
	<div>
		<span>Execute</span>
		<button class="right" onclick="execute();" title="Compiler usage help">?</button>
	</div>
	<ul><li class="collapsed submenu" onclick="setStyle(this, '!collapsed');">Execute<ul>
		<li onclick="execute('-run/g');">⚡ Run</li>
		<li onclick="execute('-debug/g');">🐞 Debug</li>
		<li onclick="execute('-profile/g');">⏱ Profile</li>
		<li onclick="execute('');">Compile only</li>
		<li onclick="execute('-doc/a/m');">Documentation</li>
		<li onclick="execute('-asm/a/m/n/s/m');">Instructions</li>
		<li onclick="execute('-api/a/m');">Symbols</li>
		<li onclick="execute('-api/a/m/u');">Usages</li>
		<li onclick="execute('-ast/m');">Syntax tree</li>
		<li onclick="execute('-profile/t/p/G/M -api/A/m/d/p/u -asm/a/n/s -ast -doc');">full dump</li>
	</ul></li></ul>
	<hr>
	<div>
		<span>Workspace</span>
		<button class="right" onclick="params.update('folder');" title="Refresh file list">⟳</button>
		<!-- TODO
		<button class="right" onclick="downloadFiles(false);">📥</button>
		<button class="right" onclick="uploadFiles();">📤</button>
		-->
	</div>
	<ul id="fileList"></ul>
	<ul>
		<hr>
		<li onclick="params.update({folder: '*'});" title="Show files including the /lib/ folder">Show all</li>
	</ul>
</div>
<div id="right-sidebar" class="sidebar">
	<div class="collapsed submenu">
	<li onclick="setStyle(parentElement, '!collapsed');">File</li>
	<ul>
		<!-- TODO
		<li>New folder</li>
		<li>New file</li>
		-->
		<li onclick="editProject();">🛠 Edit project</li>
		<li onclick="shareInput();">🔗 Share link</li>
		<li onclick="saveInput();">💾 Save (Ctrl + s)</li>
		<li onclick="saveInput(true);">💾 Save as</li>
		<li onclick="params.update({file: null});">❌ Close</li>
	</ul>
	</div>
	<div class="submenu">
	<li onclick="setStyle(parentElement, '!collapsed');">Edit</li>
	<ul>
		<li onclick="params.update('file');" title="">Revert</li>
		<li onclick="editor.execCommand('undo');" title="">Undo (Ctrl + z)</li>
		<li onclick="editor.execCommand('redo');" title="">Redo (Ctrl+Shift + z)</li>
		<hr>
		<!-- no api
		<li title="">Cut (Ctrl + x)</li>
		<li title="">Copy (Ctrl + c)</li>
		<li title="">Paste (Ctrl + v)</li>
		-->
		<hr>
		<!-- TODO
		<li onclick="editor.execCommand('?');" title="[File | Selection]">Beautify (Ctrl + b)</li>
		<li onclick="editor.execCommand('?');" title="[Line | Selection]">Block comment (Ctrl+Shift + /)</li>
		<li onclick="editor.execCommand('deleteLine');" title="[Char | Selection]">Delete (Delete)</li>
		<li onclick="editor.execCommand('dupplicate');" title="[Line | Selection]">Duplicate (Ctrl + d)</li>
		-->
		<li onclick="editor.execCommand('indentMore');" title="[Line | Selection]">Indent (Tab)</li>
		<li onclick="editor.execCommand('indentLess');" title="[Line | Selection]">Unindent (Shift + Tab)</li>
		<li onclick="editor.execCommand('toggleCommentIndented');" title="[Line | Selection]">Toggle comment (Ctrl + /)</li>
		<hr>
		<div class="collapsed submenu">
		<li onclick="setStyle(parentElement, '!collapsed')">Line</li><ul>
			<li onclick="editor.execCommand('swapLineUp');" title="">Move(Ctrl+Shift + Up)</li>
			<li onclick="editor.execCommand('swapLineDown');" title="">Move(Ctrl+Shift + Down)</li>
			<!-- TODO
			<li onclick="editor.execCommand('?joinLines');" title="">Join Lines</li>
			<li onclick="editor.execCommand('?sortLines');" title="">Sort Lines</li>
			<li onclick="editor.execCommand('?reverseLines');" title="">Reverse Lines</li>
			-->
		</ul></div>
		<div class="collapsed submenu">
		<li onclick="setStyle(parentElement, '!collapsed')">Case</li><ul>
			<li onclick="editor.execCommand('toggleCase');" title="">Toggle case(Ctrl + u)</li>
			<li onclick="editor.execCommand('upperCase');" title="">Upper case</li>
			<li onclick="editor.execCommand('lowerCase');" title="">Lower case</li>
			<li onclick="editor.execCommand('camelCase');" title="">CamelCase</li>
			<li onclick="editor.execCommand('snakeCase');" title="">Snake_case</li>
		</ul></div>
	</ul></div>
	<div class="submenu">
	<li onclick="setStyle(parentElement, '!collapsed')">Find</li><ul>
		<li onclick="editor.execCommand('find');" title="">Search (Ctrl + f)</li>
		<li onclick="editor.execCommand('findNext');" title="">Search Next (F3)</li>
		<li onclick="editor.execCommand('findPrev');" title="">Search Prev (Shift+F3)</li>
		<li onclick="editor.execCommand('findAndSelect');" title="">Search and select</li>
		<li onclick="editor.execCommand('line');" title="">Jump to line (Ctrl + g)</li>
		<li onclick="editor.execCommand('jumpToBrace');" title="">Jump to brace (Ctrl + b)</li>
		<li onclick="editor.execCommand('selectToBrace');" title="">Select to brace (Ctrl+Shift + b)</li>
	</ul></div>
	<div class="submenu">
	<li onclick="setStyle(parentElement, '!collapsed')">View</li><ul>
		<div class="collapsed submenu">
		<li onclick="setStyle(parentElement, '!collapsed')">Fold</li><ul>
			<li onclick="editor.execCommand('fold');">Fold (Ctrl + -)</li>
			<li onclick="editor.execCommand('unfold');">Unfold (Ctrl + +)</li>
			<li onclick="editor.execCommand('foldAll');">Fold All (Ctrl+Shift + -)</li>
			<li onclick="editor.execCommand('unfoldAll');">Unfold All (Ctrl+Shift + -)</li>
		</ul></div>
		<li onclick="completeAction(':%', '100');" title="">Zoom</li>
		<li id="wrap-output" onclick="setStyle(body, '!wrap-output');" title="">Wrap output</li>
		<li id="pin-left" onclick="setStyle(body, '!left-pin');" title="">Pin left sidebar</li>
		<li id="pin-right" onclick="setStyle(body, '!right-pin');" title="">Pin right sidebar</li>
		<li id="show-toolbar" onclick="setStyle(body, '!tool');" title="">Show main toolbar</li>
	</ul></div>
</div>
<div id="main-panel">
	<div id="editor-panel">
		<textarea id="input"></textarea>
	</div>
	<div id="output-panel">
		<div id="output-toolbar" class="toolbar">
			<select class="output left" id="selOutput" onchange="void(0);" onclick="event.stopPropagation()">
				<option value="Output-0">Output</option>
				<!-- <option value="Search-0">Search</option> -->
			</select>
			<span class="no-output left" onclick="setStyle(body, 'output');">Output</span>
			<!-- <span class="no-output left" onclick="setStyle(body, 'output');">Search</span> -->
			<span class="output left icon bold" onclick="editOutput();" title="Open output in editor">💾</span>
			<span class="output left icon bold" title="Clear output" onclick="terminal.clear();">❌</span>

			<span class="right icon" title="Full screen output" onclick="setStyle(body, 'output', '-editor');">⛶</span>
			<span class="output right icon bold" title="Scroll to end" onclick="terminal.scroll(true);">⏬</span>
			<span class="output right icon bold" title="Scroll to top" onclick="terminal.scroll(false);">⏫</span>
			<p/>
		</div>
		<pre id="output"></pre>
	</div>
</div>
<div id="left-overlay" class="overlay" onclick="setStyle(body, '-left-bar');"></div>
<div id="menu2-overlay" class="overlay" onclick="setStyle(body, '-right-bar');"></div>

<script type="text/javascript">
function onExecClick() {
	execute(params.exec || '-run/g');
}

var props = props || {};
props.libraries = [
	'libFile.wasm'
];
function openProjectFile(projectOrFile) {
	worker.postMessage(projectOrFile);
}
function listFiles(dir) {
	worker.postMessage({list: dir});
}

function saveInput(saveAs) {
	if (params.content !== undefined) {
		params.update({ content: btoa(editor.getValue()) });
	}
	let file = params.file;
	if (file == null || saveAs === true) {
		file = prompt('Save file as:', file || 'untitled.ci');
		if (file == null) {
			return null;
		}
	}
	let content = editor.getValue();
	worker.postMessage({ content, file });
	if (params.content !== undefined) {
		params.update({ content, file });
	} else {
		params.update({ file });
	}
	return file;
}
function execInput(args) {
	worker.postMessage({
		execute: args || []
	});
}

/* communication with worker/args
send => {
	list - download these files to the workspace directory [{path|file, url|content}]
	file - open or save the content of the file
	line - jump to / position in file
	url - download and save content
	content - save content
	workspace - switch workspace
	execute - arguments for the compiler
}

receive => {
	list - list of files in the workspace
	data - content of the requested file
	line - jump to / position in file
	print - print the message to the output
	error - print the error to the output
	exitcode - response to execute
	initialized
}

args => {
	project - download the content of the given file list
	content - overwrite the content of the editor
	file - name of file to be opened
	line - line position to jump to
	theme - override default: &theme=light|dark
	show - override default: &show=editor|output

	exec - override default: &exec=-profile/G/H/P/T
	dump - dump output to file: &dump=dump.txt|dump.json
	log - log output to file: &log=dump.txt
	mem - if 2MB memory is not enough: &mem=128M
	X
}*/
let worker = new Worker('worker.js');
worker.onmessage = function(event) {
	let data = event.data;
	//console.log('worker: ', data);
	if (data.error !== undefined) {
		terminal.print(data.error);
		actionError();
	}
	if (data.print !== undefined) {
		terminal.print(data.print);
	}
	if (data.list !== undefined) {
		fileList.innerHTML = '';
		for (let file of data.list) {
			if (file.endsWith('/')) {
				fileList.innerHTML += '<li onclick="params.update({folder: this.innerText});">' + file + '</li>';
			}
			else if (file === params.file) {
				fileList.innerHTML += '<li class="active" onclick="params.update({file: this.innerText, line: null});">' + file + '</li>';
			}
			else {
				fileList.innerHTML += '<li onclick="params.update({file: this.innerText, line: null});">' + file + '</li>';
			}
		}
	}

	if (data.content || data.file || data.line) {
		if (setContent(data.content, data.file, data.line)) {
			params.update({
				file: data.file || params.file,
				line: data.line || params.line,
				content: params.content ? data.content : null
			});
		} else {
			params.update({
				file: data.file,
				line: data.line
			});
		}
	}
	if (data.initialized) {
		params.update('workspace', 'project', 'content', 'folder', 'file');
	}
};
</script>
<script type="text/javascript" src="main.js"></script>
</body>
</html>
