<html>
<head>
	<meta charset="UTF-8">
	<title>Cmpl live demo</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">

	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="theme.css">

	<link rel="stylesheet" href="splitter.css">
	<script type="text/javascript" src="splitter.js"></script>

	<script type="text/javascript" src="lib/JsArgs.js"></script>
	<script type="text/javascript" src="lib/JsTerm.js"></script>

	<!-- Code mirror -->
	<link rel="stylesheet" href="lib/codemirror/codemirror.css">
	<link rel="stylesheet" href="lib/codemirror/fold/foldgutter.css" />
	<script src="lib/codemirror/codemirror.js"></script>
	<script src="lib/codemirror/fold/foldcode.js"></script>
	<script src="lib/codemirror/fold/brace-fold.js"></script>
	<script src="lib/codemirror/fold/comment-fold.js"></script>
	<script src="lib/codemirror/fold/foldgutter.js"></script>
	<script src="lib/codemirror/addon/active-line.js"></script>
	<script src="lib/codemirror/addon/matchbrackets.js"></script>
	<script src="lib/codemirror/addon/trailingspace.js"></script>
	<script src="lib/codemirror/addon/scroll/annotatescrollbar.js"></script>
	<script src="lib/codemirror/addon/search/matchesonscrollbar.js"></script>
	<script src="lib/codemirror/addon/search/searchcursor.js"></script>
	<script src="lib/codemirror/addon/search/match-highlighter.js"></script>
	<script src="lib/codemirror/lang/cmpl.js"></script>
</head>
<body class="dark">
<div id="mainToolBar" class="toolbar">
	<span class="left icon" onclick="showSplitter(menuSplit, '!secondary');" title="Toggle show menu">‚ò∞</span>
	<span class="left icon" onclick="saveInput();" title="Save script (Ctrl + s)">üíæ</span>
	<span id="btnExecute" class="right execute" onclick="execute(btnExecute.innerText, btnExecute.value);" title="Execute script (Ctrl + Shift + Enter)"></span>
	<!--<span class="right icon" onclick="showEditor('!primary', 'vertical', '-horizontal');" title="Toggle show output">‚ó®</span>-->
	<span class="right icon" onclick="showEditor('!primary', 'horizontal', '-vertical');" title="Toggle output">‚¨ì</span>
	<span class="right icon" onclick="setTheme(body, '!dark');" title="Toggle dark theme">‚óë</span>
	<span class="filename" title="Execute action (Ctrl + Enter)
	'#args' Execute script
	'?text' Search (Ctrl + f)
	'!text' Replace (Ctrl + r)
	':line' Go to line (Ctrl + g)
	'-' Fold all lines (Ctrl + Shift -)
	'+' Unfold all lines (Ctrl + Shift +)">
	<input id="edtFileName" placeholder="#execute; ?search; !replace; :goto; -fold; +unfold"></input></span>
</div>
<div id="menuSplit" class="content split-pane left vertical" style="top:2em;">
	<div class="content list">
		<div>
			<span>Execute</span>
			<button class="right" onclick="execute();" title="Compiler usage help">?</button>
		</div>
		<ul>
			<li onclick="execute('Run', '-run/g');" title="Execute code at full speed">‚ö° Run</li>
			<li onclick="execute('Debug', '-debug/g');" title="Execute code with error detection">üêû Debug</li>
			<li onclick="execute('Profile', '-profile/g');" title="Execute code measuring execution time">‚è± Profile</li>
			<li onclick="execute('Compile', '');">‚öô Compile only</li>
			<!--<li>
				<button onclick="execute(this.innerText, '-api/a/m/d/p/u');">Api</button>
				<button onclick="execute(this.innerText, '-asm/a/n/s/m');">Asm</button>
			</li>-->
		</ul>
		<hr>
		<div>
			<span>Project</span>
			<button class="right" onclick="listFiles(false);" title="Refresh file list">‚ü≥</button>
 			<!--<button class="right" onclick="uploadFiles();">üì§</button> -->
 			<!--<button class="right" onclick="downloadFiles(false);">üì•</button> -->
		</div>
		<ul>
			<li onclick="editProject();">üõ† Edit project</li>
			<li onclick="shareInput();">üîó Share link</li>
			<!--<li onclick="saveInput();">üíæ Save file</li> -->
			<!--<li onclick="showFile(null);">‚ùå Close file</li>-->
			<hr>
		</ul>
		<ul id="fileList">
		</ul>
		<ul>
		<li onclick="listFiles(true);" title="Show files including the /lib folder">Show all</li>
	</ul>
	</div>
	<div id="editSplit" class="content split-pane horizontal">
		<div class="text-content">
			<textarea id="input"></textarea>
		</div>
		<div class="text-content">
			<div class="toolbar">
				<span class="left icon bold" onclick="terminal.clear();" title="Clear output">‚¶∏</span>
				<span class="left icon bold" onclick="editOutput();" title="Open output in editor">‚éó</span>
				<span class="right icon bold" onclick="showEditor('!secondary');" title="Maximize">‚¨ö</span>
				<span class="right icon bold" onclick="terminal.scroll(true);" title="Scroll to end">‚è¨</span>
				<span class="right icon bold" onclick="terminal.scroll(false);" title="Scroll to top">‚è´</span>
				<span class="filename" title="Execution arguments"><input id="edtArguments"></input></span>
			</div>
			<pre id="output"></pre>
		</div>
	</div>
</div>
<div onclick="showCanvas(false)" class="modal-content hidden">
	<canvas id="canvas" width="0" onclick="event.stopPropagation()"></canvas>
</div>

<script type="text/javascript">
function openProject(files) {
	Module.files = files;
}
function listFiles(all) {
	let files = [];
	if (all === true) {
		files.push(...Module.listFiles(Module.workspace));
		files.push(...Module.listFiles('/lib'));
	} else {
		files.push(...Module.listFiles());
	}
	fileList.innerHTML = '';
	for (let file of files) {
		fileList.innerHTML += '<li onclick="showFile(this.innerText);">' + file + '</li>';
	}
	params.update('file', 'content');
}

function openInput(file, line) {
	try {
		editor.setValue(FS.readFile(file, {encoding: 'utf8'}));
	} catch(error) {
		// in case we open a file that does not exists
		console.trace(error);
	}
	params.update({file, line});
}
function saveInput() {
	if (params.content !== undefined) {
		params.update({ content: btoa(editor.getValue()) });
	}
	let file = params.file;
	if (file == null) {
		file = prompt('Save file as:', 'untitled.ci');
	}
	if (file == null) {
		return null;
	}
	params.update({ file });
	let content = editor.getValue();
	if (content !== undefined) {
		let exists = FS.analyzePath(file).exists;
		FS.mkdirTree(file.replace(/^(.*[/])?(.*)(\..*)$/, "$1"));
		FS.writeFile(file, content, {encoding: 'utf8'});
		if (!exists) {
			listFiles(false);
		}
	}
	return file;
}
function execInput(args, exactArgs) {
	if (args == null) {
		Module['callMain'](['--help']);
		return;
	}

	let file = saveInput();
	if (file == null) {
		return;
	}

	if (exactArgs !== true) {
		// todo: used libraries should be defined in the project file
		args.push('libFile.wasm');
		args.push('libGfx.wasm');
		args.push('/lib/gfxlib.ci');
		args.push(file);
	}

	edtArguments.value = args.join(' ');
	Module['callMain'](args);
}

function showCanvas(visible) {
	if (visible) {
		canvas.parentElement.classList.remove('hidden');
		if (Browser.mainLoop.oldPause === undefined) {
			Browser.mainLoop.oldPause = Browser.mainLoop.pause;
			Browser.mainLoop.pause = function() {
				canvas.parentElement.classList.add('hidden');
				Browser.mainLoop.oldPause();
				canvas.width = 0;
			}
		}
	} else {
		Module._SDL_SendQuit();
	}
}
let canvasShown = new MutationObserver(function() {
	if (canvas.width === 0) {
		return;
	}
	showCanvas(true);
});
canvasShown.observe(canvas, { attributes: true });

var Module = {
	files: null,
	initialized: false,
	dynamicLibraries: [
		'libFile.wasm',
		'libGfx.wasm'
	],
	print: function(message) { terminal.print(message); },
	canvas: document.getElementById('canvas'),

	onRuntimeInitialized: function () {
		FS.mkdirTree(Module.workspace);
		FS.chdir(Module.workspace);
		if (Module.files == null || Module.initialized) {
			return;
		}

		Module.wgetFiles(Module.files, function (inProgress) {
			listFiles(false);
			if (inProgress == 0) {
				Module.initialized = true;
			}
		});
	}
};

</script>
<script type="text/javascript" src="module.js"></script>
<script type="text/javascript" src="cmpl.js"></script>
<script type="text/javascript" src="main.js"></script>
</body>
</html>
