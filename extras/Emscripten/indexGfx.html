<html>
<head>
	<meta charset="UTF-8">
	<title>Cmpl live demo</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">

 	<link rel="stylesheet" href="style.css"> 
	<link rel="stylesheet" href="theme.css">

	<script type="text/javascript" src="lib/JsArgs.js"></script>
	<script type="text/javascript" src="lib/JsTerm.js"></script>

	<!-- Code mirror -->
	<link rel="stylesheet" href="lib/codemirror/lib/codemirror.css">
	<link rel="stylesheet" href="lib/codemirror/addon/fold/foldgutter.css" />
	<script src="lib/codemirror/lib/codemirror.js"></script>
	<script src="lib/codemirror/addon/fold/foldcode.js"></script>
	<script src="lib/codemirror/addon/fold/brace-fold.js"></script>
	<script src="lib/codemirror/addon/fold/comment-fold.js"></script>
	<script src="lib/codemirror/addon/fold/foldgutter.js"></script>
	<script src="lib/codemirror/addon/selection/active-line.js"></script>
	<script src="lib/codemirror/addon/edit/matchbrackets.js"></script>
	<script src="lib/codemirror/addon/edit/trailingspace.js"></script>
	<script src="lib/codemirror/addon/scroll/annotatescrollbar.js"></script>
	<script src="lib/codemirror/addon/search/matchesonscrollbar.js"></script>
	<script src="lib/codemirror/addon/search/searchcursor.js"></script>
	<script src="lib/codemirror/addon/search/match-highlighter.js"></script>
	<script src="lib/codemirror/addon/comment/comment.js"></script>
	<script src="lib/codemirror/cmpl.js"></script>
	<script src="lib/codemirror/keys.js"></script>
</head>
<body class="dark tool menu editor output">
<div id="toolbar">
	<!-- input -->
	<span class="left icon" title="Toggle show menu"
		onclick="setStyle(document.body, '!menu');"
		onmousedown="canvas.classList.add('hidden');"
		onmouseup="canvas.classList.remove('hidden');"
		ontouchstart="canvas.classList.add('hidden');"
		ontouchend="canvas.classList.remove('hidden');"
	>‚ò∞</span>
	<span class="editor left icon" title="Save script (Ctrl + s)" onclick="saveInput();">üíæ</span>
	<span class="left icon" title="Execute script (Ctrl + Enter)" onclick="onExecClick();">‚ñ∫</span>

	<span class="canvas right icon" title="Close canvas" onclick="showCanvas(false);">‚ùå</span>

	<span class="editor output right icon" title="Toggle show output" onclick="setStyle(body, '!output', 'editor');">‚¨ì</span>
	<span class="editor output right icon" title="Toggle dark theme" onclick="setStyle(body, '!dark');">‚óë</span>

	<span class="editor right icon" title="Toggle show output" onclick="setStyle(body, 'output', '-editor', '-menu');">‚¨ö</span>
	<span class="output right icon bold" title="Scroll to end" onclick="terminal.scroll(true);">‚è¨</span>
	<span class="output right icon bold" title="Scroll to top" onclick="terminal.scroll(false);">‚è´</span>
	<span class="output right icon bold" onclick="editOutput();" title="Open output in editor">‚éó</span>
	<span class="output right icon bold" title="Clear output" onclick="terminal.clear();">‚¶∏</span>

	<!-- filename -->
	<span class="filename" title="Execute action (Shift + Enter)
	'#args' Execute script
	'?text' Search (Ctrl + f)
	'!text' Replace (Ctrl + r)
	':line' Go to line (Ctrl + g)
	'-' Fold all lines (Ctrl + Shift + -)
	'+' Unfold all lines (Ctrl + Shift + +)">
	<input id="edtFileName" placeholder="#execute; ?search; !replace; :goto; -fold; +unfold"></input></span>
</div>
<div id="menu">
	<div>
		<span>Execute</span>
		<button class="right" onclick="execute();" title="Compiler usage help">?</button>
	</div>
	<ul>
		<li onclick="execute(selExecute.data = selExecute.value);" ><select id="selExecute" onchange="execute(this.value);" onclick="event.stopPropagation()">
			<option value="-run/g">‚ö° Run</option>
			<option value="-debug/g">üêû Debug</option>
			<option value="-profile/g">‚è± Profile</option>
			<option value="">Compile only</option>
			<option value="-doc/a/m">Documentation</option>
			<option value="-asm/a/m/n/s/m">Instructions</option>
			<option value="-api/a/m">Symbols</option>
			<option value="-api/a/m/u">Usages</option>
			<option value="-ast/m">Syntax tree</option>
			<option value="-profile/t/p/G/M -api/A/m/d/p/u -asm/a/n/s -ast -doc">full dump</option>
		</select></li>
	</ul>
	<hr>
	<div>
		<span>Workspace</span>
		<button class="right" onclick="params.update('folder');" title="Refresh file list">‚ü≥</button>
		<!--<button class="right" onclick="uploadFiles();">üì§</button> -->
		<!--<button class="right" onclick="downloadFiles(false);">üì•</button> -->
	</div>
	<ul id="fileList"></ul>
	<ul>
		<hr>
		<li onclick="editProject();">üõ† Edit project</li>
		<li onclick="shareInput();">üîó Share link</li>
		<!--<li onclick="saveInput();">üíæ Save file</li> -->
		<!--<li onclick="params.update({file: null});">‚ùå Close file</li> -->
		<!--<li onclick="params.update({folder: '*'});" title="Show files including the /lib/ folder">Show all</li> -->
	</ul>
</div>
<div>
	<div id="editor">
		<textarea id="input"></textarea>
	</div>
	<pre id="output"></pre>
</div>
<div id="canvasDiv" onclick="void(0);">
	<canvas id="canvas" width="0" onclick="event.stopPropagation()"></canvas>
	<div id="canvasMove" class="hidden" onclick="classList.add('hidden');"></div>
</div>

<script type="text/javascript">
function centerCanvas() {
	let zoom = canvas.style.zoom;
	if (zoom === "") {
		zoom = 1;
	}
	let dx = +zoom * canvas.clientWidth - canvas.parentElement.clientWidth;
	if (dx > 0) {
		canvas.parentElement.scrollLeft = dx / 2;
		canvas.style.left = 0;
	} else {
		canvas.parentElement.scrollLeft = 0;
		canvas.style.left = -dx / zoom / 2;
	}
	let dy = +zoom * canvas.clientHeight - canvas.parentElement.clientHeight;
	if (dy > 0) {
		canvas.parentElement.scrollTop = dy / 2;
		canvas.style.top = 0;
	} else {
		canvas.parentElement.scrollTop = 0;
		canvas.style.top = -dy / zoom / 2;
	}
	canvasMove.style.width = Math.max(canvas.width, canvas.parentElement.clientWidth);
	canvasMove.style.height = Math.max(canvas.height, canvas.parentElement.clientHeight);
}
function onExecClick() {
	// if canvas is already shown, zoom or pan
	if (document.body.classList.contains('canvas')) {
		if (canvasMove.classList.contains('hidden')) {
			canvasMove.classList.remove('hidden');
			canvas.style.zoom = 1;
		} else {
			canvasMove.classList.add('hidden');
			let zoom = Math.min(screen.width / canvas.width, screen.height / canvas.height);
			if (zoom < 1) {
				canvas.style.zoom = zoom;
			}
		}
		centerCanvas();
		return;
	}
	execute(selExecute.data || '-run/g');
}

function onSyncWorkSpace(error) {
	if (error == null) {
		return;
	}
	console.error(error);
}

var props = props || {};
props.libraries = [
	'libFile.wasm',
	'libGfx.wasm',
	'/lib/gfxlib.ci'
];
function openProjectFile(projectOrFile) {
	if (projectOrFile.workspace != null) {
		if (Module.initWorkspace(projectOrFile.workspace, function () {
			openProjectFile(projectOrFile);
			listFiles(params.folder || '.');
		})) {
			return;
		}
	}
	if (projectOrFile.list != null) {
		Module.wgetFiles(projectOrFile.list, function (inProgress) {
			if (inProgress > 0) {
				return;
			}
			FS.syncfs(onSyncWorkSpace);
			listFiles(params.folder || '.');
		});
	}
	if (projectOrFile.file != null) {
		try {
			let content = Module.readFile(projectOrFile.file);
			setContent(content, projectOrFile.file, projectOrFile.line);
		} catch (error) {
			// in case we open a file that does not exists
			console.log(error);
		}
	}
}
function listFiles(dir) {
	fileList.innerHTML = '';
	for (let file of Module.listFiles(dir)) {
		if (file.endsWith('/')) {
			fileList.innerHTML += '<li onclick="params.update({folder: this.innerText});">' + file + '</li>';
		} else {
			fileList.innerHTML += '<li onclick="params.update({file: this.innerText, line: null});">' + file + '</li>';
		}
	}
	params.update('file', 'content');
}

function saveInput() {
	if (params.content !== undefined) {
		params.update({ content: btoa(editor.getValue()) });
	}
	let file = params.file;
	if (file == null) {
		file = prompt('Save file as:', 'untitled.ci');
		if (file == null) {
			return null;
		}
	}
	let content = editor.getValue();
	if (content !== undefined) {
		let exists = Module.pathExists(file);
		Module.saveFile(file, content);
		FS.syncfs(onSyncWorkSpace);
		if (!exists) {
			listFiles(params.folder || '.');
		}
	}
	if (params.content !== undefined) {
		params.update({ content, file });
	} else {
		params.update({ file });
	}
	return file;
}
function execInput(args) {
	// show overlay while compiling and initializing
	//canvas.parentElement.classList.remove('hidden');
	document.body.classList.add('canvas');
	setTimeout(function() {
		try {
			Module['callMain'](args || []);
		} catch (error) {
			if (canvas.width === 0) {
				//canvas.parentElement.classList.add('hidden');
				document.body.classList.remove('canvas');
			}
			throw error;
		}
		if (canvas.width === 0) {
			//canvas.parentElement.classList.add('hidden');
			document.body.classList.remove('canvas');
		}
	});
}

function showCanvas(visible) {
	if (!visible) {
		Module._SDL_SendQuit();
		return;
	}

	//canvas.parentElement.classList.remove('hidden');
	document.body.classList.add('canvas');

	if ('ontouchstart' in document.documentElement) {
		// adapt canvas to full hd resolution on mobile phones
		let zoom = Math.min(screen.width / canvas.width, screen.height / canvas.height);
		if (zoom < 1) {
			canvas.style.zoom = zoom;
		}
	}
	centerCanvas();
	if (Browser.mainLoop.oldPause === undefined) {
		Browser.mainLoop.oldPause = Browser.mainLoop.pause;
		Browser.mainLoop.pause = function() {
			document.body.classList.remove('canvas');
			Browser.mainLoop.oldPause();
			canvas.width = 0;
		}
	}
}
let canvasShown = new MutationObserver(function() {
	if (canvas.width === 0) {
		return;
	}
	if (canvasShown.width === canvas.width) {
		return;
	}
	showCanvas(true);
	canvasShown.width = canvas.width;
});
canvasShown.observe(canvas, { attributes: true });

var Module = {
	initialized: false,
	dynamicLibraries: [
		'libFile.wasm',
		'libGfx.wasm'
	],
	externalLibraries: [{
		file: '/lib/gfxlib.ci',
		url: '/Cmpl/cmplGfx/lib/gfxlib.ci'
	}, {
		file: '/lib/gfx/color.ci',
		url: '/Cmpl/cmplGfx/lib/gfx/color.ci'
	}, {
		file: '/lib/vec/vec4f.ci',
		url: '/Cmpl/lib/vec/vec4f.ci'
	}, {
		file: '/lib/vec/mat4f.ci',
		url: '/Cmpl/lib/vec/mat4f.ci'
	}, {
		path: '/lib/vec/vec2d.ci',
		url: '/Cmpl/lib/vec/vec2d.ci'
	}],
	print: function(message) { terminal.print(message); },
	canvas: document.getElementById('canvas'),

	onRuntimeInitialized: function () {
		ENV.CMPL_HOME = '/';
		FS.mkdirTree(Module.workspace);
		FS.chdir(Module.workspace);

		Module.wgetFiles(Module.externalLibraries, function (inProgress) {
			if (inProgress > 0) {
				return;
			}
			params.update('workspace', 'project', 'content', 'folder', 'file');
			Module.initialized = true;
		});
	}
};

</script>
<script type="text/javascript" src="module.js"></script>
<script type="text/javascript" src="cmpl.js"></script>
<script type="text/javascript" src="main.js"></script>
</body>
</html>
