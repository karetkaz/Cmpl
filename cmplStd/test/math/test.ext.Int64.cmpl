inline Signed = Int64;
inline Unsigned = Uint64;

enum {
	bits: Unsigned.bits;
	inc: 0x00ffffffffffffff;
	rot: 80;
}

for (int32 i = 0; i < bits; i += 1) {
	int64 x = 1U << i;
	assertEq(i, Unsigned.scanReverse(x), "scanReverse", i);
	assertEq(i, Unsigned.scanForward(x), "scanForward", i);

	assertEq(Unsigned.leadingZeros(x), Unsigned.trailingZeros(Unsigned.reverseBits(x)), "leadingZeros", x, i);
	assertEq(Unsigned.trailingZeros(x), Unsigned.leadingZeros(Unsigned.reverseBits(x)), "trailingZeros", x, i);
	assertEq(Unsigned.trailingZeros(x), x == 0 ? bits : (Unsigned.length(x & -x) - 1), "assertion failed", x, i);

	if (i != 0) {
		assertEq(Unsigned.scanForward(i), bits - 1 - Unsigned.scanReverse(Unsigned.reverseBits(i)), "assertion failed", i);
		assertEq(Unsigned.scanReverse(i), bits - 1 - Unsigned.scanForward(Unsigned.reverseBits(i)), "assertion failed", i);
	} else {
		assertEq(-1, Unsigned.scanForward(i), "assertion failed", i);
		assertEq(-1, Unsigned.scanReverse(i), "assertion failed", i);
	}

	for (int32 rotate = 0; rotate < rot; rotate += 1) {
		uint64 x = i & Unsigned.max;
		uint64 y = Unsigned.rotateLeft(x, rotate);
		uint64 z = Unsigned.rotateRight(y, rotate);
		assertEq(x, z, "rotate failed", x, y, z, rotate);
	}

	assertEq(Unsigned.length(i), i == 0 ? 0 : uint64(Float64.log2((i & Unsigned.max) * 2)), "rotate failed", i);
}

for (uint64 i = Unsigned.min; i < Unsigned.max - inc; i += inc) {
	uint64 ovf = 0;
	assert(Unsigned.leadingZeros(i) == Unsigned.trailingZeros(Unsigned.reverseBits(i)), "leadingZeros", i);
	assert(Unsigned.trailingZeros(i) == Unsigned.leadingZeros(Unsigned.reverseBits(i)), "trailingZeros", i);
	assertEq(Unsigned.trailingZeros(i), i == 0 ? bits : (Unsigned.length(i & -i) - 1), "assertion failed", i);

	assertEq(~i & Unsigned.max, Unsigned.cmt(i), "assertion failed", i);
	assertEq(i == 0 ? 0 : 1, Unsigned.sign(i), "assertion failed", i);
	assertEq(i < 0 ? -i : i, Unsigned.abs(i), "assertion failed", i);

	for (uint64 j = Unsigned.min; j < Unsigned.max - inc; j += inc) {
		int32 cmp = Unsigned.compare(i, j);
		if (i == j) { assert(cmp == 0, "compare failed", i, j, cmp); }
		if (i != j) { assert(cmp != 0, "compare failed", i, j, cmp); }
		if (i <= j) { assert(cmp <= 0, "compare failed", i, j, cmp); }
		if (i < j) { assert(cmp < 0, "compare failed", i, j, cmp); }
		if (i >= j) { assert(cmp >= 0, "compare failed", i, j, cmp); }
		if (i > j) { assert(cmp > 0, "compare failed", i, j, cmp); }

		assertEq(i | j, Unsigned.or(i, j), "assertion failed", i, j);
		assertEq(i ^ j, Unsigned.xor(i, j), "assertion failed", i, j);
		assertEq(i & j, Unsigned.and(i, j), "assertion failed", i, j);

		assertEq(i >> j, Unsigned.shr(i, j), "assertion failed", i, j);
		assertEq(i << j & Unsigned.max, Unsigned.shl(i, j), "assertion failed", i, j);

		assertEq(i < j ? i : j, Unsigned.min(i, j), "assertion failed", i, j);
		assertEq(i > j ? i : j, Unsigned.max(i, j), "assertion failed", i, j);

		uint64 add = i + j;
		uint64 addLo = Unsigned.add(i, j, &ovf);
		// assertEq(add >> bits, ovf, "assertion failed", i, j, add);
		assertEq(add & Unsigned.max, addLo & Unsigned.max, "assertion failed", i, j, add);

		uint64 sub = i - j;
		uint64 subLo = Unsigned.sub(i, j, &ovf);
		// assertEq(sub >> bits & Unsigned.max, ovf, "assertion failed", i, j, sub);
		assertEq(sub & Unsigned.max, subLo & Unsigned.max, "assertion failed", i, j, sub);

		uint64 mul = i * j;
		uint64 mulLo = Unsigned.mul(i, j, &ovf);
		// assertEq(mul >> bits, ovf, "assertion failed", i, j);
		assertEq(mul & Unsigned.max, mulLo & Unsigned.max, "assertion failed", i, j);
	}
}

for (int32 i = Signed.min; i < Signed.max - inc; i += inc) {
	int64 ovf = 0;
	int64 neg = Signed.neg(i, &ovf);
	assertEq(-i & Unsigned.max, neg, "assertion failed", i);
	//assertEq(-int128(i) != neg, ovf != 0, "assertion failed", i);
	assertEq(i == 0 ? 0 : i < 0 ? -1 : 1, Signed.sign(i), "assertion failed", i);
	// todo: Int8.abs(-128) should be -128, 128 does not fit in 8 bits
	assertEq(i < 0 ? -i : i, Signed.abs(i), "assertion failed", i);

	for (int32 j = Signed.min; j < Signed.max - inc; j += inc) {
		int32 cmp = Signed.compare(i, j);
		if (i == j) { assert(cmp == 0, "compare failed", i, j, cmp); }
		if (i != j) { assert(cmp != 0, "compare failed", i, j, cmp); }
		if (i <= j) { assert(cmp <= 0, "compare failed", i, j, cmp); }
		if (i < j) { assert(cmp < 0, "compare failed", i, j, cmp); }
		if (i >= j) { assert(cmp >= 0, "compare failed", i, j, cmp); }
		if (i > j) { assert(cmp > 0, "compare failed", i, j, cmp); }

		assertEq(i < j ? i : j, Int32.min(i, j), "assertion failed", i, j);
		assertEq(i > j ? i : j, Int32.max(i, j), "assertion failed", i, j);

		int64 add = i + j;
		int64 addLo = Signed.add(i, j, &ovf);
		assertEq(add >> bits, ovf, "assertion failed", i, j, add);
		assertEq(add & Unsigned.max, uint64(addLo), "assertion failed", i, j, add);

		int64 sub = i - j;
		int64 subLo = Signed.sub(i, j, &ovf);
		assertEq(sub >> bits, ovf, "assertion failed", i, j, sub);
		assertEq(sub & Unsigned.max, uint64(subLo), "assertion failed", i, j, sub);

		int64 mul = i * j;
		int64 mulLo = Signed.mul(i, j, &ovf);
		assertEq(mul >> bits, uint64(ovf), "assertion failed", i, j);
		assertEq(mul & Unsigned.max, uint64(mulLo), "assertion failed", i, j, mul);
	}
}
